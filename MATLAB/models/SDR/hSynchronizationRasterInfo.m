classdef hSynchronizationRasterInfo
%hSynchronizationRasterInfo - FR1 synchronization signal raster information
%   hSynchronizationRasterInfo is a class that supplies information on FR1
%   operating bands and the location of synchronization signals within the
%   operating bands.
%
%   hSynchronizationRasterInfo properties:
%
%   Operating band and synchronization signal tables (Read-only)
%   SynchronizationRasterFR1 - FR1 synchronization signal raster table (TS
%                              38.101-1 Table 5.4.3.3-1)
%   FR1DLOperatingBand       - FR1 operating band frequency information
%                              table (TS 38.101-1 Table 5.2-1)
%
%   hSynchronizationRasterInfo static methods:
%
%   gscn2frequency      - Convert the global synchronization channel number
%                         (GSCN) to frequency (Hz)
%   frequency2gscn      - Convert frequency (Hz) to closest GSCN value
%   frequency2band      - Convert frequency (Hz) to FR1 NR operating band
%   getSCSOptions       - Generate subcarrier spacing possiblities from
%                         frequency
%   getMinimumBandwidth - Determine minimum bandwidth of SSB from frequency
%                         and subcarrier spacing (see TS 38.101-1 Table
%                         5.3.5-1)
%   getBlockPattern     - Determine SSB block pattern from frequency and
%                         subcarrier spacing (see TS 38.101-1 Table
%                         5.4.3.3-1)

%   Copyright 2023 The MathWorks, Inc.

    properties (Constant)
        % Constant lookup tables taken from 3GPP TS 38.101-1 V18.2
        SynchronizationRasterFR1 = getFR1SSRasterEntriesTable;
        FR1DLOperatingBand = getFR1DLOperatingBands;
    end

    methods(Static)
        function centerFrequencies = gscn2frequency(gscns)
        %GSCN2FREQUENCY - Returns the frequency value based on the GSCN input. The
        %GSCN to frequency conversion is based on Table 5.4.3.1-1 of 3GPP TS 38.104
        %V18.2.
            centerFrequencies = zeros(size(gscns));
            for i = 1:length(gscns)
                gscn = gscns(i);
                if gscn>1 && gscn<7499
                    gscnMod = mod(gscn,3);
                    if gscnMod == 2
                        m = 1;
                    elseif gscnMod == 1
                        m = 5;
                    else
                        m = 3;
                    end
                    n = (gscn - (m-3)/2)/3;
                    centerFrequency = n*1200e3 + m*50e3;
                elseif gscn>7498 && gscn<22256
                    n = gscn - 7499;
                    centerFrequency = n*1.44e6 + 3000e6;
                elseif gscn>22255 && gscn<26640
                    n = gscn - 22256;
                    centerFrequency = n*17.28e6 + 24250.08e6;
                else
                    error("hSynchronizationRasterInfo:gscn2frequency:invalidGSCN", ...
                          "Invalid GSCN value (%d).", gscn)
                end
                centerFrequencies(i) = centerFrequency;
            end
        end

        function gscns = frequency2gscn(frequencies)
        % FREQUENCY2GSCN - Returns the closest GSCN value based on the
        % FREQUENCY input. The frequency to GSCN conversion is based on
        % Table 5.4.3.1-1 of 3GPP TS 38.104
            gscns = zeros(size(frequencies));
            for i = 1:length(frequencies)
                frequency = frequencies(i);
                if frequency >= 24250.08e6 && frequency <= 100000e6
                    n = (frequency - 24250.08e6)/17.28e6;
                    gscn = round(n + 22256);
                elseif frequency >= 3000e6 && frequency < 24250.08e6
                    n = (frequency - 3000e6)/1.44e6;
                    gscn = round(n + 7499);
                elseif frequency >= 1.25e6 && frequency < 3000e6
                    m = [1 3 5];
                    n = (frequency - m*50e3)/1200e3;
                    closestN = round(n(1));
                    [~,idx] = min(abs(n-closestN));
                    gscn = round(3*closestN + (m(idx)-3)/2);
                else
                    error("hSynchronizationRasterInfo:frequency2gscn:invalidFrequency", ...
                          "Frequency (%.f Hz) cannot be converted to a valid GSCN value.",frequency);
                end
                if mod(n,1) ~= 0
                    warning("hSynchronizationRasterInfo:frequency2gscn:nNotInteger", ...
                            "The frequency %.f Hz does not correspond to a valid GSCN value. " + ...
                            "Rounding to nearest GSCN.", frequency)
                end
                gscns(i) = gscn;
            end
        end

        function band = frequency2band(frequency)
            rowNames = string(hSynchronizationRasterInfo.FR1DLOperatingBand.Properties.RowNames);
            cf = frequency/1e6;
            band = rowNames(cf>=hSynchronizationRasterInfo.FR1DLOperatingBand.("Lower Bound (MHz)")&cf<=hSynchronizationRasterInfo.FR1DLOperatingBand.("Upper Bound (MHz"));
            if isempty(band)
                warning('hSynchronizationRasterInfo:frequency2band:OutOfBand', ...
                        'The frequency %.f Hz does not belong to any FR1 NR band.',frequency)
            end
        end

        function scsOptions = getSCSOptions(frequency)
            band = hSynchronizationRasterInfo.frequency2band(frequency);
            if isempty(band)
                scsOptions = ["15 kHz" "30 kHz"];
            else
                scsOptions = string([hSynchronizationRasterInfo.SynchronizationRasterFR1.(band(1)).SCS])+ " kHz";
            end
        end

        function minBW = getMinimumBandwidth(scs,frequency)
            band = hSynchronizationRasterInfo.frequency2band(frequency);
            if isempty(band) || contains(band(1),["n96" "n102" "n104"])
                minBW = 20;
            elseif matches(scs,"30 kHz")
                minBW = 10;
            else % scs == "15 kHz"
                minBW = 5;
            end
        end

        function blockPattern = getBlockPattern(scs,frequency)
            band = hSynchronizationRasterInfo.frequency2band(frequency);
            scsNumeric = double(extract(scs,digitsPattern));
            if isempty(band)
                if scsNumeric == 15
                    blockPattern = "Case A";
                else
                    blockPattern = "Case C";
                end
            else
                bandInfo = hSynchronizationRasterInfo.SynchronizationRasterFR1.(band(1));
                blockPattern = "Case " + bandInfo([bandInfo.SCS] == scsNumeric).BlockPattern;
            end
        end
    end

end

function dlOperatingBands = getFR1DLOperatingBands
% Taken from 3GPP TS 38.101-1 V18.2 Table 5.2-1
    lowerBound = [2110 1930 1805 869 2620 925 729 746 758 860 791 1525 1930 ...
                  859 758 717 2350 2010 2570 1880 2300 2496 5150 3550 1432 ...
                  1427 2483.5 2110 2110 738 1995 617 1475 1432 1427 3300 3300 ...
                  4400 728 2496 1427 1432 1427 1432 5925 919.4 1900 5925 6425]';

    upperBound = [2170 1990 1880 894 2690 960 746 756 768 875 821 1559 1995 ...
                  894 803 728 2360 2025 2620 1920 2400 2690 5925 3700 1517 ...
                  1432 2495 2200 2200 758 2020 652 1518 1517 1432 4200 3800 ...
                  5000 746 2690 1432 1517 1432 1517 7125 925 1910 6425 7125]';

    bands = {'n1'; 'n2'; 'n3'; 'n5'; 'n7'; 'n8'; 'n12'; 'n13'; ...
             'n14'; 'n18'; 'n20'; 'n24'; 'n25'; 'n26'; 'n28'; 'n29'; ...
             'n30'; 'n34'; 'n38'; 'n39'; 'n40'; 'n41'; 'n46'; 'n48'; ...
             'n50'; 'n51'; 'n53'; 'n65'; 'n66'; 'n67'; 'n70'; 'n71'; ...
             'n74'; 'n75'; 'n76'; 'n77'; 'n78'; 'n79'; 'n85'; 'n90'; ...
             'n91'; 'n92'; 'n93'; 'n94'; 'n96'; 'n100'; 'n101'; 'n102'; ...
             'n104'};
    dlOperatingBands = table(lowerBound,upperBound,'RowNames',bands);
    dlOperatingBands.Properties.VariableNames = ["Lower Bound (MHz)" "Upper Bound (MHz"];
end

function ssRasterTable = getFR1SSRasterEntriesTable
% Taken from 3GPP TS 38.101-1 V18.2 Table 5.4.3.3-1
    ssRasterTable = struct( ...
        'n1', struct('SCS',15,'BlockPattern','A','GSCN',5279:5419), ...
        'n2', struct('SCS',15,'BlockPattern','A','GSCN',4829:4969), ...
        'n3', struct('SCS',15,'BlockPattern','A','GSCN',4517:4693), ...
        'n5', [struct('SCS',15,'BlockPattern','A','GSCN',2177:2230); ...
               struct('SCS',30,'BlockPattern','B','GSCN',2183:2224)], ...
        'n7', struct('SCS',15,'BlockPattern','A','GSCN',6554:6718), ...
        'n8', struct('SCS',15,'BlockPattern','A','GSCN',2318:2395), ...
        'n12', struct('SCS',15,'BlockPattern','A','GSCN',1828:1858), ...
        'n13', struct('SCS',15,'BlockPattern','A','GSCN',1871:1885), ...
        'n14', struct('SCS',15,'BlockPattern','A','GSCN',1901:1915), ...
        'n18', struct('SCS',15,'BlockPattern','A','GSCN',2156:2182), ...
        'n20', struct('SCS',15,'BlockPattern','A','GSCN',1982:2047), ...
        'n24', [struct('SCS',15,'BlockPattern','A','GSCN',3818:3892); ...
                struct('SCS',30,'BlockPattern','B','GSCN',3824:3886)], ...
        'n25', struct('SCS',15,'BlockPattern','A','GSCN',4829:4981), ...
        'n28', struct('SCS',15,'BlockPattern','A','GSCN',1901:2002), ...
        'n29', struct('SCS',15,'BlockPattern','A','GSCN',1798:1813), ...
        'n30', struct('SCS',15,'BlockPattern','A','GSCN',5879:5893), ...
        'n34', [struct('SCS',15,'BlockPattern','A','GSCN',[5032, 5043, 5054]); ...
                struct('SCS',30,'BlockPattern','C','GSCN',5036:5050)], ...
        'n38', [struct('SCS',15,'BlockPattern','A','GSCN',[6432, 6443, 6457, 6468, ...
                                                           6479, 6493, 6507, 6518, ...
                                                           6532, 6543]); ...
                struct('SCS',30,'BlockPattern','C','GSCN',6437:6538)], ...
        'n39', [struct('SCS',15,'BlockPattern','A','GSCN',[4707, 4715, 4718, 4729, ...
                                                           4732, 4743, 4747, 4754, ...
                                                           4761, 4768, 4772, 4782, ...
                                                           4786, 4793]); ...
                struct('SCS',30,'BlockPattern','C','GSCN',4712:4789)], ...
        'n40', struct('SCS',30,'BlockPattern','C','GSCN',5762:5989), ...
        'n41', [struct('SCS',15,'BlockPattern','A','GSCN',6246:3:6717); ...
                struct('SCS',30,'BlockPattern','C','GSCN',6252:3:6714)], ...
        'n46', struct('SCS',30,'BlockPattern','C','GSCN',[8996, 9010, 9024, 9038, ...
                                                          9051, 9065, 9079, 9093, ...
                                                          9107, 9121, 9218, 9232, ...
                                                          9246, 9260, 9274, 9288, ...
                                                          9301, 9315, 9329, 9343, ...
                                                          9357, 9371, 9385, 9402, ...
                                                          9416, 9430, 9444, 9458, ...
                                                          9472, 9485, 9499, 9513]), ...
        'n48', struct('SCS',30,'BlockPattern','C','GSCN',7884:7982), ...
        'n50', struct('SCS',30,'BlockPattern','C','GSCN',3590:3781), ...
        'n51', struct('SCS',15,'BlockPattern','A','GSCN',3572:3574), ...
        'n53', [struct('SCS',15,'BlockPattern','A','GSCN',6215:6232); ...
                struct('SCS',30,'BlockPattern','C','GSCN',6221:6226)], ...
        'n54', struct('SCS',15,'BlockPattern','A','GSCN',4181:4182), ...
        'n65', struct('SCS',15,'BlockPattern','A','GSCN',5279:5494), ...
        'n66', [struct('SCS',15,'BlockPattern','A','GSCN',5279:5494); ...
                struct('SCS',30,'BlockPattern','B','GSCN',5285:5488)], ...
        'n67', struct('SCS',15,'BlockPattern','A','GSCN',1850:1888), ...
        'n70', struct('SCS',15,'BlockPattern','A','GSCN',4993:5044), ...
        'n71', struct('SCS',15,'BlockPattern','A','GSCN',1547:1624), ...
        'n74', struct('SCS',15,'BlockPattern','A','GSCN',3692:3790), ...
        'n75', struct('SCS',15,'BlockPattern','A','GSCN',3584:3787), ...
        'n76', struct('SCS',15,'BlockPattern','A','GSCN',3572:3574), ...
        'n77', struct('SCS',30,'BlockPattern','C','GSCN',7711:8329), ...
        'n78', struct('SCS',30,'BlockPattern','C','GSCN',7711:8051), ...
        'n79', struct('SCS',30,'BlockPattern','C','GSCN',8475:8884), ...
        'n85', struct('SCS',15,'BlockPattern','A','GSCN',1826:1858), ...
        'n90', [struct('SCS',15,'BlockPattern','A','GSCN',6245:6718); ...
                struct('SCS',30,'BlockPattern','C','GSCN',6252:6714)], ...
        'n91', struct('SCS',15,'BlockPattern','A','GSCN',3572:3574), ...
        'n92', struct('SCS',15,'BlockPattern','A','GSCN',3584:3787), ...
        'n93', struct('SCS',15,'BlockPattern','A','GSCN',3572:3574), ...
        'n94', struct('SCS',15,'BlockPattern','A','GSCN',3584:3787), ...
        'n96', struct('SCS',30,'BlockPattern','C','GSCN',[9548, 9562, 9576, 9590, ...
                                                          9603, 9617, 9631, 9645, ...
                                                          9659, 9673, 9687, 9701, ...
                                                          9714, 9728, 9742, 9756, ...
                                                          9770, 9784, 9798, 9812, ...
                                                          9826, 9840, 9853, 9867, ...
                                                          9881, 9895, 9909, 9923, ...
                                                          9937, 9951, 9964, 9978, ...
                                                          9992, 10006, 10020, 10034, ...
                                                          10048, 10062, 10076, 10090, ...
                                                          10103, 10117, 10131, 10145, ...
                                                          10159, 10173, 10187, 10201, ...
                                                          10214, 10228, 10242, 10256, ...
                                                          10270, 10284, 10298, 10312, ...
                                                          10325, 10339, 10353]), ...
        'n100', struct('SCS',15,'BlockPattern','A','GSCN',2303:2307), ...
        'n101', [struct('SCS',15,'BlockPattern','A','GSCN',4754:4768); ...
                 struct('SCS',30,'BlockPattern','C','GSCN',4760:4764)], ...
        'n102', struct('SCS',30,'BlockPattern','C','GSCN',[9535, 9548, 9562, 9576, ...
                                                           9590, 9603, 9617, 9631, ...
                                                           9645, 9659, 9673, 9687, ...
                                                           9701, 9714, 9728, 9742, ...
                                                           9756, 9770, 9784, 9798, ...
                                                           9812, 9826, 9840, 9853, ...
                                                           9867]), ...
        'n104', struct('SCS',30,'BlockPattern','C','GSCN',9882:7:10358));

end
